print("Loading...")
local sid = rednet.lookup("SimOSStore")
if not sid then 
printError("Could not find the SimOS package server.") 
return 
end

local function unzip(tab, loc)
for i=1,#tab do
if type(tab[i][2]) == "table" then
fs.makeDir(fs.combine(loc, tab[i][1]))
unzip(tab[i][2], fs.combine(loc, tab[i][1]))
else
local fi = fs.open(fs.combine(loc, tab[i][1]), "w")
fi.write(tab[i][2])
fi.close()
end 
end 
end

local function getInfo(id)
rednet.send(sid, {"info", id}, "SStore")
local _,info = rednet.receive("SStore", 10)
local n = system.drawMenu({"Install", "Don't"}, info)
if n==1 then
rednet.send(sid, {"get", id}, "SStore")
local _,package = rednet.receive("SStore", 10)
local pkname = table.remove(package, 1)
fs.makeDir("/SimOS/programs/"..pkname[3])
unzip(package, "/SimOS/programs/"..pkname[3])
local fi = fs.open("/SimOS/programs/programs", "r")
local progs = textutils.unserialise(fi.readAll())
fi.close()
table.insert(progs, pkname)
fi = fs.open("/SimOS/programs/programs", "w")
fi.write(textutils.serialise(progs))
fi.close()
end 
end

while true do
local n = system.drawMenu({"Search", "Exit"},"SimOS package store:\n")
if n==2 then return
elseif n==1 then
write("Search term:")
rednet.send(sid, {"search",read()}, "SStore")
local _, results = rednet.receive("SStore", 10)
table.insert(results, 1, "Return")
n = system.drawMenu(results)
if n>1 then getInfo(results[n]) end
end 
end
