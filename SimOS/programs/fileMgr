local tArgs = {...}
if tArgs[2]=="-select" then
  table.insert(tArgs, 1, table.remove(tArgs))
end
local ori = #system.get("programs")
local path = (tArgs[2] or tArgs[1]) or ""
if path=="-select" then
  path = ""
end
local set = system.get("fileMgr")
if tArgs[1]=="-select" then
  set.proguf={"Select this file", "Edit", "Cancel"}
end
local n = 1
while true do
  local fl = fs.list(path)
  local fc = 0
  for i=1, #fl do
    if fs.isDir(fs.combine(path, fl[i])) then
      fc=fc+1
      table.insert(fl, fc, table.remove(fl, i))
      --I need to test if this is really needed, but I'll throw it in anyway
      i=i-1
    end
  end
  if path ~= "" then 
    table.insert(fl, 1, "..") 
  end
  if not fs.isReadOnly(path) then table.insert(fl, "New...") end
  table.insert(fl, "Exit")
  n = system.drawMenu(fl, "Directory of "..path..":\n", n)
  if n==#fl then 
    return nil
  elseif n==#fl-1 and not fs.isReadOnly(path) then
    n = system.drawMenu({"New file","New folder", "Cancel"}, "Create new in directory "..path..":\n")
    if n==2 then
      write("Folder Name:")
      local input = read()
      if not fs.exists(fs.combine(path,input)) then
        fs.makeDir(fs.combine(path,input))
      else 
        printError("Folder exists.") 
        sleep(1) 
      end
    elseif n==1 then
      write("File name:")
      local input = read()
      if not fs.exists(fs.combine(path,input)) then
        fs.open(fs.combine(path,input), "w").close()
      else 
        printError("File exists.") 
        sleep(1) 
      end
    end
  else
    if fs.isDir(fs.combine(path,fl[n])) then
      path = fs.combine(path, fl[n])
      n=1
    else 
      local act = system.drawMenu(set.proguf,fs.combine(path, fl[n]).."\n")
      if tArgs[1]=="-select" and act==1 then
        return ("/"..fs.combine(path, fl[n]))
      elseif set.prog[act]=="$ADDPROG" then
        local progs = system.get("programs")
        write("Name of program:")
        table.insert(progs, {read(), "/"..fs.combine(path,fl[n]), "rmlistentry"})
        system.set("programs", progs)
      else
        shell.run(string.gsub(set.prog[act], "$PATH", "\\"..fs.combine(path, fl[n])))
      end 
    end 
  end 
end
if ori<#system.get("programs") and tArgs[1]~="-select" then
  system.saveSettings()
end
